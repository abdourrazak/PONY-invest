<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©initialisation des Utilisateurs - AXML</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            color: #856404;
        }
        .warning h3 {
            margin: 0 0 10px 0;
            color: #d63031;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #ddd;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .user-item {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
            font-family: monospace;
        }
        .user-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ R√©initialisation Globale</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è ATTENTION</h3>
            <p>Cette action va r√©initialiser <strong>TOUS</strong> les utilisateurs de la plateforme :</p>
            <ul>
                <li>Solde remis √† <strong>1000 XOF</strong></li>
                <li>R√©compenses de parrainage √† <strong>0</strong></li>
                <li>Historique des gains quotidiens <strong>effac√©</strong></li>
                <li>Forfaits VIP remis √† <strong>0</strong></li>
            </ul>
            <p><strong>Cette action est irr√©versible !</strong></p>
        </div>

        <button id="loadUsersBtn" onclick="loadAllUsers()">
            üìã Charger la Liste des Utilisateurs
        </button>

        <button id="resetBtn" onclick="resetAllUsers()" disabled style="background: linear-gradient(135deg, #d63031 0%, #a71e34 100%);">
            üîÑ R√âINITIALISER TOUS LES UTILISATEURS
        </button>

        <div id="status"></div>
        <div id="userList"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js'
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js'
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js'

        // Configuration Firebase - VOS VRAIES CL√âS
        const firebaseConfig = {
            apiKey: "AIzaSyCkf_1ekS90hbAvcUnX709iB6SZECiDjcs",
            authDomain: "globalplatform-2e94c.firebaseapp.com", 
            projectId: "globalplatform-2e94c",
            storageBucket: "globalplatform-2e94c.firebasestorage.app",
            messagingSenderId: "665288476986",
            appId: "1:665288476986:web:f51435bbf580bcb1a6a803"
        }

        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const db = getFirestore(app)

        let allUsers = []

        window.loadAllUsers = async function() {
            const statusDiv = document.getElementById('status')
            const loadBtn = document.getElementById('loadUsersBtn')
            const resetBtn = document.getElementById('resetBtn')
            const userListDiv = document.getElementById('userList')

            try {
                loadBtn.disabled = true
                loadBtn.textContent = '‚è≥ Connexion...'
                
                statusDiv.innerHTML = '<div class="info">üîê Authentification en cours...</div>'

                // Pas besoin d'authentification - utiliser les r√®gles publiques
                // await signInAnonymously(auth)
                
                statusDiv.innerHTML = '<div class="info">üì° Chargement des utilisateurs...</div>'

                const usersRef = collection(db, 'users')
                const snapshot = await getDocs(usersRef)
                
                allUsers = []
                snapshot.forEach((doc) => {
                    const userData = doc.data()
                    if (userData.numeroTel) {
                        allUsers.push({
                            id: doc.id,
                            numeroTel: userData.numeroTel,
                            referralCode: userData.referralCode || 'N/A'
                        })
                    }
                })

                statusDiv.innerHTML = `<div class="success">‚úÖ ${allUsers.length} utilisateurs charg√©s avec succ√®s</div>`
                
                // Afficher la liste des utilisateurs
                userListDiv.innerHTML = `
                    <h3>üë• Utilisateurs trouv√©s (${allUsers.length}) :</h3>
                    <div class="user-list">
                        ${allUsers.map(user => 
                            `<div class="user-item">üì± ${user.numeroTel} | üîó ${user.referralCode}</div>`
                        ).join('')}
                    </div>
                `

                resetBtn.disabled = false
                loadBtn.textContent = '‚úÖ Utilisateurs Charg√©s'

            } catch (error) {
                console.error('Erreur:', error)
                statusDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`
                loadBtn.disabled = false
                loadBtn.textContent = 'üìã Charger la Liste des Utilisateurs'
            }
        }

        window.resetAllUsers = function() {
            if (!confirm(`‚ö†Ô∏è CONFIRMATION REQUISE\n\nVoulez-vous vraiment r√©initialiser ${allUsers.length} utilisateurs ?\n\nCette action est IRR√âVERSIBLE !`)) {
                return
            }

            const statusDiv = document.getElementById('status')
            const resetBtn = document.getElementById('resetBtn')

            try {
                resetBtn.disabled = true
                resetBtn.textContent = '‚è≥ R√©initialisation...'
                
                statusDiv.innerHTML = '<div class="info">üîÑ R√©initialisation en cours...</div>'

                let resetCount = 0
                
                // M√âTHODE 1: R√©initialiser pour tous les utilisateurs connus
                allUsers.forEach((user) => {
                    const phone = user.numeroTel
                    
                    localStorage.setItem(`userFunds_${phone}`, '1000')
                    localStorage.setItem(`referralRewards_${phone}`, '0')
                    localStorage.setItem(`rewardHistory_${phone}`, '[]')
                    localStorage.setItem(`forfaitsVipActifs_${phone}`, '0')
                    localStorage.setItem(`gainsHoraire_${phone}`, '0')
                    localStorage.setItem(`totalDepense_${phone}`, '0')
                    
                    resetCount++
                })
                
                // M√âTHODE 2: Nettoyer TOUT le localStorage (plus radical)
                const keysToRemove = []
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i)
                    if (key && (key.includes('userFunds_') || key.includes('referralRewards_') || 
                               key.includes('rewardHistory_') || key.includes('forfaitsVipActifs_') ||
                               key.includes('gainsHoraire_') || key.includes('totalDepense_'))) {
                        keysToRemove.push(key)
                    }
                }
                
                // Supprimer toutes les cl√©s trouv√©es
                keysToRemove.forEach(key => localStorage.removeItem(key))
                
                // Recr√©er avec les valeurs par d√©faut pour tous les utilisateurs
                allUsers.forEach((user) => {
                    const phone = user.numeroTel
                    localStorage.setItem(`userFunds_${phone}`, '1000')
                    localStorage.setItem(`referralRewards_${phone}`, '0')
                    localStorage.setItem(`rewardHistory_${phone}`, '[]')
                    localStorage.setItem(`forfaitsVipActifs_${phone}`, '0')
                    localStorage.setItem(`gainsHoraire_${phone}`, '0')
                    localStorage.setItem(`totalDepense_${phone}`, '0')
                })

                statusDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ R√©initialisation termin√©e !<br>
                        üìä ${resetCount} utilisateurs r√©initialis√©s<br>
                        üóëÔ∏è ${keysToRemove.length} cl√©s localStorage supprim√©es<br>
                        üí∞ Tous les soldes remis √† 1000 XOF<br>
                        üéÅ Toutes les r√©compenses effac√©es<br><br>
                        <strong>‚ö†Ô∏è IMPORTANT: Actualisez votre plateforme (F5) pour voir les changements</strong>
                    </div>
                `
                
                resetBtn.textContent = '‚úÖ R√©initialisation Termin√©e'

            } catch (error) {
                console.error('Erreur:', error)
                statusDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`
                resetBtn.disabled = false
                resetBtn.textContent = 'üîÑ R√âINITIALISER TOUS LES UTILISATEURS'
            }
        }
    </script>
</body>
</html>
