<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Transaction Sync</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #results { margin-top: 20px; }
        .transaction { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .transaction.pending { background: #fff3cd; }
        .transaction.success { background: #d4edda; }
        .transaction.rejected { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>🔍 Debug Synchronisation Transactions AXML</h1>
    
    <div>
        <label for="userId">ID Utilisateur:</label>
        <input type="text" id="userId" placeholder="UID de l'utilisateur" style="width: 300px; padding: 8px; margin: 10px;">
        <br>
        <button onclick="subscribeToUserTransactions()">📊 Écouter Transactions</button>
        <button onclick="listAllTransactions()">📋 Lister Toutes</button>
        <button onclick="clearLogs()">🧹 Effacer Logs</button>
    </div>
    
    <div id="results"></div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_your_api_key",
            authDomain: "axml-global.firebaseapp.com",
            projectId: "axml-global",
            storageBucket: "axml-global.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let unsubscribeFunction = null;

        function log(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('results').innerHTML = '';
        }

        function subscribeToUserTransactions() {
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                log('❌ Veuillez entrer un ID utilisateur', 'error');
                return;
            }

            // Arrêter l'écoute précédente si elle existe
            if (unsubscribeFunction) {
                unsubscribeFunction();
                log('🔇 Arrêt de l\'écoute précédente', 'warning');
            }

            log(`🎯 Début écoute transactions pour: ${userId}`, 'success');

            const query = db.collection('transactions')
                .where('userId', '==', userId)
                .orderBy('submittedAt', 'desc');

            unsubscribeFunction = query.onSnapshot((snapshot) => {
                log(`📊 ${snapshot.size} transactions reçues`, 'success');
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `transaction ${data.status}`;
                    transactionDiv.innerHTML = `
                        <strong>Transaction ${doc.id}</strong><br>
                        📋 Type: ${data.type}<br>
                        💰 Montant: ${data.amount} FCFA<br>
                        📱 Méthode: ${data.paymentMethod}<br>
                        ⏰ Statut: <strong>${data.status}</strong><br>
                        📅 Date: ${data.submittedAt ? new Date(data.submittedAt.seconds * 1000).toLocaleString() : 'N/A'}<br>
                        📞 Téléphone: ${data.userNumeroTel || 'N/A'}
                    `;
                    document.getElementById('results').appendChild(transactionDiv);
                });

                if (snapshot.size === 0) {
                    log('❌ Aucune transaction trouvée pour cet utilisateur', 'warning');
                }
            }, (error) => {
                log(`❌ Erreur écoute: ${error.message}`, 'error');
            });
        }

        function listAllTransactions() {
            log('📋 Récupération de toutes les transactions...', 'success');
            
            db.collection('transactions')
                .orderBy('submittedAt', 'desc')
                .limit(50)
                .get()
                .then((snapshot) => {
                    log(`📊 ${snapshot.size} transactions totales trouvées`, 'success');
                    
                    const transactions = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        transactions.push({
                            id: doc.id,
                            ...data
                        });
                    });

                    // Grouper par utilisateur
                    const byUser = transactions.reduce((acc, t) => {
                        const userId = t.userId;
                        if (!acc[userId]) acc[userId] = [];
                        acc[userId].push(t);
                        return acc;
                    }, {});

                    Object.keys(byUser).forEach(userId => {
                        const userTransactions = byUser[userId];
                        log(`👤 Utilisateur ${userId}: ${userTransactions.length} transactions`);
                        
                        userTransactions.forEach(t => {
                            log(`  📄 ${t.id}: ${t.type} ${t.amount}FCFA [${t.status}] ${t.userNumeroTel || 'N/A'}`);
                        });
                    });
                })
                .catch((error) => {
                    log(`❌ Erreur récupération: ${error.message}`, 'error');
                });
        }

        // Message d'instructions
        log('🚀 Outil de debug des transactions prêt', 'success');
        log('📝 Instructions:', 'log');
        log('1. Entrez l\'UID de l\'utilisateur à surveiller', 'log');
        log('2. Cliquez sur "Écouter Transactions" pour surveiller en temps réel', 'log');
        log('3. Dans un autre onglet, connectez-vous comme admin et changez le statut d\'une transaction', 'log');
        log('4. Observez si les changements apparaissent ici en temps réel', 'log');
    </script>
</body>
</html>
